"use strict";(self.webpackChunkintelehealth_ui=self.webpackChunkintelehealth_ui||[]).push([[478],{6478:(b,d,s)=>{s.r(d),s.d(d,{VideoCallO3Module:()=>T});var h=s(4476),u=s(9671),a=(s(685),s(2678)),m=s(4465),t=s(4650),p=s(7185),f=s(5383),C=s(6879);function g(i,c){if(1&i){const e=t.EpF();t.TgZ(0,"tr")(1,"td"),t._uU(2),t.qZA(),t.TgZ(3,"td"),t._uU(4),t.qZA(),t.TgZ(5,"td",3)(6,"button",0),t.NdJ("click",function(){const n=t.CHM(e).$implicit,r=t.oxw();return t.KtG(r.handleAction(n.uuid))}),t._uU(7,"Action"),t.qZA()()()}if(2&i){const e=c.$implicit;t.xp6(2),t.Oqu(e.name),t.xp6(2),t.Oqu(e.uuid)}}const k=[{path:"",component:(()=>{class i{constructor(e,o,l){this.toastr=e,this.socketService=o,this.coreService=l,this.socket=null,this.roomId=null,this.isCalling=!1,this.callTo=null,this.callAccepted=!1,this.token="",this.calledBy=null,this.isMuted=!1,this.isVideoOn=!1,this.room=null,this.callerName=null,this.currentUser=(0,m.TL)(!0,"user"),this.members=[{name:"Admin2",uuid:"0a09425b-9cea-4f04-a90d-200cda5edb1f"},{name:"Super User",uuid:"82f18b44-6814-11e8-923f-e9a88dcb533f"},{name:"Doctro1",uuid:"b338f57d-69a9-4884-b077-c2059baf9ba4"}],this.WS_URL="wss://demo.intelehealth.org:9090",this.SOCKET_SERVER_URL="wss://intelehealth-o3.mpower-social.com:3004",this.SERVER_URL_RTC="https://intelehealth-o3.mpower-social.com:3000"}handleAction(e){console.log("Action clicked for UUID:",e)}ngOnInit(){var e=this;return(0,u.Z)(function*(){console.log("ngOnInitngOnInit"),e.socket||(yield e.socketService.initSocket(!0)),console.log(e.socketService.socket,"this.socketService.socket"),e.socket=e.socketService.socket})()}ngOnDestroy(){this.socket&&(this.socket.disconnect(),this.socket=null)}handleJoinCall(e){this.socket&&this.roomId&&(this.socket.emit("create_or_join_hw",{patientId:this.roomId}),this.socket.emit("call-connected",{initiator:e,room:this.calledBy.room,socketId:this.calledBy.appSocketId,nurseId:this.calledBy.connectToDrId}),this.getToken(this.roomId,this.calledBy.nurseId),this.callAccepted=!0,this.isCalling=!1)}handleRejectCall(){this.socket&&(console.log("dr_call_reject",this.calledBy),this.socket.emit("dr_call_reject",this.calledBy.nurseId),this.isCalling=!1,this.roomId=null)}getToken(e,o){fetch(`${this.SERVER_URL_RTC}/api/getToken?name=b338f57d-69a9-4884-b077-c2059baf9ba4&roomId=${e}&nurseName=${o}`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(n=>n.json()).then(n=>{this.token=n.token}).catch(n=>{console.error("Error fetching the token:",n)})}startCall(){if(this.dialogRef2)return this.dialogRef2.close(),void(this.isCalling=!1);this.isCalling=!0,this.dialogRef2=this.coreService.openVideoCallModal({patientId:this.generateUUID(),visitId:"",connectToDrId:this.currentUser.uuid,patientName:"Super User",nurseId:"82f18b44-6814-11e8-923f-e9a88dcb533f",initiator:"dr",drPersonUuid:"82f18b44-6814-11e8-923f-e9a88dcb533f"}),this.dialogRef2.afterClosed().subscribe(e=>{this.dialogRef2=void 0,this.isCalling=!1})}handleCallUser(e,o){if(console.log("handleCallUser",e,this.socket),this.socket){const l=this.generateUUID();this.getToken(l,e),this.roomId=l,this.callTo={name:o,nurseId:e},this.isCalling=!0,this.socket.emit("create_or_join_hw",{patientId:l,connectToDrId:e}),this.socket.emit("call",{nurseId:e,doctorName:"yourUserName",roomId:l})}this.startCall()}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const o=16*Math.random()|0;return("x"===e?o:3&o|8).toString(16)})}setupRoom(){var e=this;return(0,u.Z)(function*(){const o=new a.du({adaptiveStream:!0,dynacast:!0,videoCaptureDefaults:{resolution:a.z4.h1080},audioCaptureDefaults:{echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0}});o.prepareConnection(e.SERVER_URL_RTC,e.token),o.on(a.TQ.TrackSubscribed,e.handleTrackSubscribed).on(a.TQ.TrackUnsubscribed,e.handleTrackUnsubscribed).on(a.TQ.ActiveSpeakersChanged,e.handleActiveSpeakerChange).on(a.TQ.Disconnected,e.handleDisconnect).on(a.TQ.LocalTrackUnpublished,e.handleLocalTrackUnpublished),yield o.connect(e.WS_URL,e.token),console.log("Connected to room:",o.name),e.room=o,yield o.localParticipant.enableCameraAndMicrophone(),yield o.localParticipant.setMicrophoneEnabled(!1),yield o.localParticipant.setCameraEnabled(!1)})()}handleTrackSubscribed(e,o,l){if(e.kind===a.fQ.Kind.Video||e.kind===a.fQ.Kind.Audio){const n=e.attach(),r=document.getElementById("yourUserId");n instanceof HTMLVideoElement&&(n.style.width="100%",n.style.height="100%",n.style.objectFit="cover"),r&&r.appendChild(n)}}handleTrackUnsubscribed(e,o,l){e.detach().forEach(n=>n.remove())}handleLocalTrackUnpublished(e,o){e.track.detach().forEach(l=>l.remove())}handleActiveSpeakerChange(e){}handleDisconnect(){console.log("Disconnected from room")}toggleMute(){this.room&&(this.room.localParticipant.setMicrophoneEnabled(!this.isMuted),this.isMuted=!this.isMuted)}toggleVideo(){this.room&&(console.log("toggleVideo off"),this.room.localParticipant.setCameraEnabled(!this.isVideoOn),this.isVideoOn=!this.isVideoOn)}handleLeave(){console.log(this.calledBy,this.callTo),this.socket?.emit("cancel_dr",{socketId:this.socket.id,nurseId:this.calledBy?this.calledBy.nurseId:this.callTo?.nurseId}),this.resetCall()}resetCall(){this.room?.disconnect(),this.roomId=null,this.isCalling=!1,this.callAccepted=!1,this.callTo=null,this.calledBy=null,this.room=null,this.isMuted=!1,this.isVideoOn=!1}}return i.\u0275fac=function(e){return new(e||i)(t.Y36(p._W),t.Y36(f.$),t.Y36(C.p))},i.\u0275cmp=t.Xpm({type:i,selectors:[["app-video-call-list-data-table"]],decls:15,vars:1,consts:[[3,"click"],["border","1","cellpadding","10","cellspacing","0",2,"width","100%","border-collapse","collapse"],[4,"ngFor","ngForOf"],[1,"pr-0"]],template:function(e,o){1&e&&(t.TgZ(0,"h2"),t._uU(1,"video-call-openmrs3 works!"),t.qZA(),t.TgZ(2,"button",0),t.NdJ("click",function(){return o.handleCallUser("82f18b44-6814-11e8-923f-e9a88dcb533f","Doctor1")}),t._uU(3,"Click Me"),t.qZA(),t.TgZ(4,"table",1)(5,"thead")(6,"tr")(7,"th"),t._uU(8,"Name"),t.qZA(),t.TgZ(9,"th"),t._uU(10,"UUID"),t.qZA(),t.TgZ(11,"th"),t._uU(12,"Action"),t.qZA()()(),t.TgZ(13,"tbody"),t.YNc(14,g,8,2,"tr",2),t.qZA()()),2&e&&(t.xp6(14),t.Q6J("ngForOf",o.members))}}),i})()}];let T=(()=>{class i{}return i.\u0275fac=function(e){return new(e||i)},i.\u0275mod=t.oAB({type:i}),i.\u0275inj=t.cJS({imports:[h.Bz.forChild(k),h.Bz]}),i})()}}]);